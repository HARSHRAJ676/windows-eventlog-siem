from typing import List, Dict, Any

# Whitelisted legitimate system processes (exclude from alerts)
WHITELIST_PROCESSES = [
    "msmpseng.exe",      # Windows Defender
    "msmpeng.exe",       # Windows Defender  
    "mpcmdrun.exe",      # Windows Defender Command Line
    "svchost.exe",       # Windows Service Host (too common)
    "conhost.exe",       # Console Window Host
    "dwm.exe",           # Desktop Window Manager
    "csrss.exe",         # Client Server Runtime
    "wininit.exe",       # Windows Start-Up Application
    "services.exe",      # Services Control Manager
    "lsass.exe",         # Local Security Authority
    "smss.exe",          # Session Manager
    "winlogon.exe",      # Windows Logon Process
]

SUSPICIOUS_PATHS = [
    r"C:\Users\Public",
    r"C:\Windows\Temp",
    r"\AppData\Local\Temp",
    r"\Downloads"
]

# Known malicious tools (SOC analyst must-know list)
SUSPICIOUS_PROCESSES = [
    "mimikatz", "psexec", "procdump", "pwdump", "wce.exe",
    "gsecdump", "crackmapexec", "bloodhound", "sharphound",
    "rubeus", "certutil", "bitsadmin", "mshta.exe", "regsvr32",
    "rundll32", "wscript", "cscript", "installutil"
]

# Legitimate tools abused by attackers
LOLBINS = [
    "certutil.exe", "bitsadmin.exe", "mshta.exe", "regsvr32.exe",
    "rundll32.exe", "installutil.exe", "msbuild.exe", "cmstp.exe",
    "regasm.exe", "regsvcs.exe", "wmic.exe"
]

BLOCKLIST_HASHES = {"44d88612fea8a8f36de82e1278abb02f"}


def format_process_alert(alert_type: str, process: str, user: str = None, parent: str = None, cmdline: str = None) -> str:
    """
    Format process monitoring alert in professional SOC style.
    """
    if alert_type == "suspicious_tool":
        alert = [
            "ðŸš¨ Malicious Tool Detected",
            "",
            f"Process: {process}",
        ]
        if user:
            alert.append(f"User: {user}")
        if cmdline:
            alert.append(f"Command Line: {cmdline[:150]}...")
        if parent:
            alert.append(f"Parent Process: {parent}")
        alert.extend([
            "",
            "Risk Level: Critical ðŸ”´",
            "MITRE ATT&CK: T1003 - Credential Dumping",
            "",
            "Recommended Actions:",
            "â€¢ Immediately isolate system",
            "â€¢ Terminate malicious process",
            "â€¢ Perform full credential reset",
            "â€¢ Hunt for lateral movement"
        ])
    
    elif alert_type == "lolbin":
        alert = [
            "âš ï¸ Living-off-the-Land Binary Detected",
            "",
            f"Process: {process}",
        ]
        if user:
            alert.append(f"User: {user}")
        if cmdline:
            alert.append(f"Command Line: {cmdline[:150]}...")
        alert.extend([
            "",
            "Risk Level: High ðŸ”´",
            "MITRE ATT&CK: T1218 - System Binary Proxy Execution",
            "",
            "Recommended Actions:",
            "â€¢ Review command line for malicious intent",
            "â€¢ Check for downloaded files",
            "â€¢ Verify user legitimacy"
        ])
    
    else:  # suspicious_path
        alert = [
            "âš ï¸ Suspicious Process Location",
            "",
            f"Process: {process}",
        ]
        if user:
            alert.append(f"User: {user}")
        if cmdline:
            alert.append(f"Command Line: {cmdline[:150]}...")
        alert.extend([
            "",
            "Risk Level: Medium âš ï¸",
            "MITRE ATT&CK: T1204 - User Execution",
            "",
            "Recommended Actions:",
            "â€¢ Verify process legitimacy",
            "â€¢ Submit file for malware analysis",
            "â€¢ Check process digital signature"
        ])
    
    return "\n".join(alert)


def detect_malware_exec(events: List[Dict[str, Any]], thresholds: Dict[str, Any]) -> List[Dict[str, Any]]:
    alerts: List[Dict[str, Any]] = []
    
    for e in events:
        # Event ID 4688 = New process creation
        if e.get('event_id') == 4688:
            cmd = (e.get('command') or e.get('message') or '')
            cmd_lower = cmd.lower()
            user = e.get('user')
            
            # Extract process name from command line
            process_name = cmd.split('\\')[-1].split()[0] if '\\' in cmd else cmd.split()[0]
            process_name_lower = process_name.lower()
            
            # Skip whitelisted legitimate system processes
            if any(whitelist in process_name_lower for whitelist in WHITELIST_PROCESSES):
                continue
            
            # Check for known malicious tools (CRITICAL)
            if any(tool in cmd_lower for tool in SUSPICIOUS_PROCESSES):
                alerts.append({
                    'severity': 'CRITICAL',
                    'title': '[CRITICAL] Malicious Tool Execution Detected',
                    'description': format_process_alert('suspicious_tool', process_name, user, None, cmd)
                })
            
            # Check for LOLBins (Living-off-the-Land Binaries)
            elif any(lolbin in cmd_lower for lolbin in LOLBINS):
                # Only alert if used with suspicious flags
                if any(flag in cmd_lower for flag in ['-decode', 'downloadstring', 'urlcache', 'split', '-f', '/i:']):
                    # Include timestamp in title to allow multiple alerts for repeated commands
                    timestamp_suffix = e.get('timestamp', '').split('.')[0][-8:].replace(':', '')
                    alerts.append({
                        'severity': 'HIGH',
                        'title': f'[HIGH] LOLBin Abuse - {process_name} - {timestamp_suffix}',
                        'description': format_process_alert('lolbin', process_name, user, None, cmd)
                    })
            
            # Check for suspicious execution paths
            elif any(p.lower() in cmd_lower for p in SUSPICIOUS_PATHS):
                alerts.append({
                    'severity': 'MEDIUM',
                    'title': '[MEDIUM] Process from Suspicious Location',
                    'description': format_process_alert('suspicious_path', process_name, user, None, cmd)
                })
    
    return alerts
